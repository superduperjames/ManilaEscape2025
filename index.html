<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ghoul Roulette Assignments</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url('https://res.cloudinary.com/eventmobi/image/upload/v1759429344/_James%20Assets/.test%20app%20assets/MML%20October%202025/ezgif.com-effects.gif');
      background-size: cover;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
      padding: 40px;
      backdrop-filter: blur(4px);
    }

    h1 {
      text-shadow: 2px 2px 10px #000;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .container {
      background: rgba(0, 0, 0, 0.75);
      padding: 25px 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
      text-align: center;
    }

    textarea, input[type="email"], input[type="password"] {
      width: 100%;
      border-radius: 10px;
      border: none;
      padding: 10px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      background: rgba(255,255,255,0.1);
      color: white;
      margin-top: 10px;
      font-size: 1em;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      margin-bottom: 5px;
    }

    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #a600ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #7b00c7;
    }

    #result, #userResult {
      margin-top: 20px;
      white-space: pre-wrap;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      display: none;
    }

    .hidden { display: none; }

  </style>
</head>
<body>

  <!-- USER SECTION -->
  <div class="container" id="userSection">
    <h1>Find Your Ghoul Identity</h1>
    <p>Enter your email... and let fate whisper your assigned name.</p>
    <input type="email" id="userEmail" placeholder="Type your email..." />
    <button onclick="fetchAssignment()">Reveal My Codename</button>

    <div id="userResult"></div>

    <p style="margin-top:30px; font-size:0.9em; opacity:0.8;">
      Admin? <a href="#" onclick="showLogin()">Click here</a>
    </p>
  </div>

  <!-- ADMIN LOGIN -->
  <div class="container hidden" id="loginSection">
    <h1>Admin Login</h1>
    <p>Enter the secret incantation to access the pairing ritual.</p>
    <input type="password" id="adminPassword" placeholder="Enter password..." />
    <br />
    <button onclick="checkLogin()">Enter</button>
  </div>

  <!-- ADMIN SECTION -->
  <div class="container hidden" id="adminSection">
    <h1>Generate Assignments</h1>
    <p>Enter a list of emails and a list of codenames with genders. One per line.</p>

    <label for="emails">Emails</label>
    <textarea id="emails" placeholder="e.g.\njack@example.com\nluna@example.com"></textarea>

    <label for="codenames">Codenames & Gender</label>
    <textarea id="codenames" placeholder="e.g.\nPhantom - Male\nWhisper - Female"></textarea>

    <button onclick="generateAssignments()">Generate Assignments</button>

    <div id="result"></div>
  </div>

  <script>
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbySgPWk1WSX-bgb0WaV3kXTMuWE1bcRiHZ4vtwkNDoDTE0wfi5D1wFTGd6kvWPf_EIX/exec";
    const ADMIN_PASSWORD = "escape2025";

    function showLogin() {
      document.getElementById("userSection").classList.add("hidden");
      document.getElementById("loginSection").classList.remove("hidden");
    }

    function checkLogin() {
      const input = document.getElementById("adminPassword").value;
      if (input === ADMIN_PASSWORD) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("adminSection").classList.remove("hidden");
      } else {
        alert("Wrong incantation! The spirits reject you.");
      }
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function generateAssignments() {
      const emails = document.getElementById("emails").value.trim().split("\n").filter(e => e);
      const codenames = document.getElementById("codenames").value.trim().split("\n").filter(c => c);

      if (emails.length === 0 || codenames.length === 0) {
        alert("Please enter both email and codename lists.");
        return;
      }

      const shuffledCodenames = shuffle([...codenames]);
      const assignments = [];
      const resultsText = [];

      for (let i = 0; i < emails.length; i++) {
        const email = emails[i];
        const pair = shuffledCodenames[i % shuffledCodenames.length];
        const [codename, gender] = pair.split(" - ");
        resultsText.push(`${email} â†’ ${codename} (${gender})`);
        assignments.push([new Date().toLocaleString(), email, codename, gender]);
      }

      document.getElementById("result").innerText = resultsText.join("\n");
      document.getElementById("result").style.display = "block";

      try {
        const response = await fetch(GAS_WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify({
            sheetName: "Sheet2",
            rows: assignments
          }),
          headers: { "Content-Type": "application/json" }
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("Assignments saved successfully to Sheet2!");
        } else {
          alert("Error saving: " + result.message);
        }
      } catch (err) {
        alert("Error connecting to Google Script: " + err);
      }
    }

    // USER FETCH
    async function fetchAssignment() {
      const email = document.getElementById("userEmail").value.trim();
      if (!email) {
        alert("Please enter your email.");
        return;
      }

      const userResult = document.getElementById("userResult");
      userResult.innerHTML = "Summoning your fate...";
      userResult.style.display = "block";

      try {
        const res = await fetch(`${GAS_WEBAPP_URL}?email=${encodeURIComponent(email)}&sheetName=Sheet2`);
        const data = await res.json();

        if (data.status === "found") {
          userResult.innerHTML = `
            <strong>Your Ghoul Codename:</strong><br>
            ${data.codename} (${data.gender})
          `;
        } else {
          userResult.innerHTML = "No record found. The spirits remain silent...";
        }
      } catch (err) {
        userResult.innerHTML = "Connection error. The portal is unstable...";
      }
    }
  </script>
</body>
</html>
