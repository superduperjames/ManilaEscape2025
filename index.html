<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manila Escape Ghoul Swap Spinner</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url('https://res.cloudinary.com/eventmobi/image/upload/v1759502727/_James%20Assets/.test%20app%20assets/MML%20October%202025/218016_small-ezgif.com-video-to-gif-converter.gif') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    h1 {
      font-size: 2em;
      text-shadow: 2px 2px 5px black;
    }

    input, textarea {
      padding: 8px;
      margin: 8px;
      width: 55%;
      border: none;
      border-radius: 6px;
      font-size: 1em;
    }

    button {
      padding: 10px 16px;
      margin: 8px;
      background-color:black;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #ba68c8;
    }

    #adminBtn {
      position: absolute;
      top: 12px;
      right: 18px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 0.8em;
      padding: 6px 10px;
    }

    #adminPanel {
      display: none;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .modal button {
      margin: 10px;
    }
  </style>
</head>
<body>

  <button id="adminBtn">Admin Login</button>

  <div id="mainContent">
    <h1>üï∑Ô∏è Ghoul Swap Spinner üï∏Ô∏è</h1>
    <p>Enter your email below and find out who the spinner has chosen for you...</p>
    <input type="email" id="userEmail" placeholder="Enter your email" required />
    <br>
    <button onclick="checkAssignment()">Spin!</button>
    <p id="result"></p>
  </div>

  <!-- Admin Login Modal -->
  <div class="modal" id="adminLoginModal">
    <div class="modal-content">
      <h2>Admin Login</h2>
      <input type="password" id="adminPass" placeholder="Enter admin password" />
      <br>
      <button onclick="checkAdmin()">Login</button>
      <button onclick="closeModal('adminLoginModal')">Cancel</button>
      <p id="loginError" style="color:red;"></p>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <p id="confirmText"></p>
      <button id="confirmYes">Yes</button>
      <button onclick="closeModal('confirmModal')">Cancel</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Control Panel</h2>
    <textarea id="emailList" placeholder="Email entries (comma-separated)"></textarea><br>
    <textarea id="codeList" placeholder="Codenames and Gender (comma-separated)"></textarea><br>
    <button onclick="generateAssignments()">Generate Assignments</button>
    <button onclick="showConfirm('Reshuffle all entries?', reshuffle)">Reshuffle</button>
    <button onclick="showConfirm('Clear all entries?', clearEntries)">Clear Entries</button>
    <br><br>
    <button onclick="closeAdmin()">Close</button>
    <p id="adminStatus"></p>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwdh-RqSOToSZ5kapVz1tgcjQ2xuJQPlgK6T5_sVSEy_nVifEnCAaZ30BLDxRBWLXUilA/exec';
    const ADMIN_PASSWORD = 'escape2025';

    document.getElementById('adminBtn').addEventListener('click', () => {
      document.getElementById('adminLoginModal').style.display = 'flex';
    });

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function checkAdmin() {
      const pass = document.getElementById('adminPass').value;
      if (pass === ADMIN_PASSWORD) {
        closeModal('adminLoginModal');
        document.getElementById('adminPanel').style.display = 'block';
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password!';
      }
    }

    function closeAdmin() {
      document.getElementById('adminPanel').style.display = 'none';
    }

    function showConfirm(text, callback) {
      document.getElementById('confirmText').textContent = text;
      const yesBtn = document.getElementById('confirmYes');
      yesBtn.onclick = () => { closeModal('confirmModal'); callback(); };
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function generateAssignments() {
      const emails = document.getElementById('emailList').value.split(',').map(e => e.trim()).filter(Boolean);
      const codes = document.getElementById('codeList').value.split(',').map(e => e.trim()).filter(Boolean);
      if (emails.length === 0 || codes.length === 0) {
        alert('Please enter both lists.');
        return;
      }

      // Shuffle and pair randomly
      const shuffled = [...codes].sort(() => Math.random() - 0.5);
      const results = emails.map((email, i) => ({
        email: email,
        result: shuffled[i % shuffled.length]
      }));

      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ type: 'adminReplace', entries: results }),
      })
      .then(() => document.getElementById('adminStatus').textContent = 'Assignments generated and saved!')
      .catch(err => document.getElementById('adminStatus').textContent = 'Error saving assignments.');
    }

    function reshuffle() {
      generateAssignments();
    }

    function clearEntries() {
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ type: 'clearAll' }),
      })
      .then(() => document.getElementById('adminStatus').textContent = 'All entries cleared!')
      .catch(() => document.getElementById('adminStatus').textContent = 'Error clearing entries.');
    }

    function checkAssignment() {
      const email = document.getElementById('userEmail').value.trim().toLowerCase();
      if (!email) {
        alert('Please enter a valid email.');
        return;
      }
      fetch(scriptURL + '?action=download')
        .then(res => res.text())
        .then(csv => {
          const rows = csv.split('\n').map(r => r.split(','));
          const match = rows.find(r => r[0].replace(/"/g, '').toLowerCase() === email);
          document.getElementById('result').textContent = match
            ? `Your code name: ${match[1].replace(/"/g, '')}`
            : 'No assignment found yet.';
        });
    }
  </script>

</body>
</html>
